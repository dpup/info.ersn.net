# ERSN API Server - Current Architecture Flow

## Information Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              CLIENT REQUESTS                                            â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
  â”‚                                                                                     â”‚
  â”‚ HTTP GET /api/v1/roads          HTTP GET /api/v1/weather         HTTP GET /         â”‚
  | â–¼                               â–¼                                â–¼                  â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                            PREFAB SERVER FRAMEWORK                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   gRPC Gateway  â”‚  â”‚   gRPC Gateway  â”‚  â”‚  Homepage       â”‚                          â”‚
â”‚  â”‚   (HTTPâ†’gRPC)   â”‚  â”‚   (HTTPâ†’gRPC)   â”‚  â”‚  Handler        â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚           â”‚                       â”‚                       â”‚                             â”‚
â”‚           â–¼                       â–¼                       â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚  RoadsService   â”‚  â”‚ WeatherService  â”‚  â”‚  Static HTML    â”‚                          â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚  Response       â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”˜
  â”‚                 â”‚                                                                   â”‚
  â–¼                 â–¼                                                                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                 â”‚ â”‚              PERIODIC REFRESH SERVICE                       â”‚     â”‚
â”‚  CACHE CHECK    â”‚ â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Every 5 minutes:                       â”‚     â”‚
â”‚                 â”‚ â”‚  â”‚   Timer     â”‚â”€â”€â”€â”€â–¶ RoadsService.ListRoads()              â”‚     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚ â”‚  â”‚  Goroutine  â”‚     (Simulated API Request)                â”‚     â”‚
â”‚  â”‚ Fresh Data? â”‚â”‚ â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚     â”‚
â”‚  â”‚             â”‚â”‚ â”‚                                                             â”‚     â”‚
â”‚  â”‚ YES â†’ Returnâ”‚â”‚ â”‚                                                             â”‚     â”‚
â”‚  â”‚ NO  â†’ Fetch â”‚â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                     â”‚
          â”‚                                                                             â”‚
          â–¼                                                                             â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          DATA REFRESH PIPELINE                                          â”‚
â”‚                                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚ refreshRoadData â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚refreshWeatherDataâ”‚                       â”‚
â”‚  â”‚                 â”‚                         â”‚                  â”‚                       â”‚
â”‚  â”‚ For each road:  â”‚                         â”‚ For each loc:    â”‚                       â”‚
â”‚  â”‚ â–¼               â”‚                         â”‚ â–¼                â”‚                       â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                         â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                       â”‚
â”‚  â”‚ â”‚processMonitoâ”‚ â”‚                         â”‚ â”‚getWeatherForâ”‚  â”‚                       â”‚
â”‚  â”‚ â”‚redRoad()    â”‚ â”‚                         â”‚ â”‚Location()   â”‚  â”‚                       â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                         â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚           â”‚                                                                             â”‚
â”‚           â–¼                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    EXTERNAL API CALLS                                           â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚ â”‚
â”‚  â”‚ â”‚   Google    â”‚  â”‚    Caltrans     â”‚  â”‚  OpenWeatherMap â”‚                     â”‚ â”‚
â”‚  â”‚ â”‚   Routes    â”‚  â”‚  KML Feeds      â”‚  â”‚      API        â”‚                     â”‚ â”‚
â”‚  â”‚ â”‚             â”‚  â”‚                 â”‚  â”‚                 â”‚                     â”‚ â”‚
â”‚  â”‚ â”‚ Traffic +   â”‚  â”‚ Lane Closures + â”‚  â”‚ Weather Data +  â”‚                     â”‚ â”‚
â”‚  â”‚ â”‚ Polylines   â”‚  â”‚ CHP Incidents   â”‚  â”‚ Alerts          â”‚                     â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚ â”‚
â”‚  â”‚       â”‚                   â”‚                     â”‚                             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚          â”‚                   â”‚                     â”‚                               â”‚
â”‚          â–¼                   â–¼                     â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    DATA PROCESSING PIPELINE                                     â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚ Google Response    â”‚    Caltrans KML      â”‚    Weather Response                 â”‚ â”‚
â”‚  â”‚       â”‚            â”‚          â”‚           â”‚           â”‚                        â”‚ â”‚
â”‚  â”‚       â–¼            â”‚          â–¼           â”‚           â–¼                        â”‚ â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚ â”‚
â”‚  â”‚ â”‚ Extract     â”‚    â”‚ â”‚ Parse KML +     â”‚  â”‚  â”‚ Format Weather  â”‚              â”‚ â”‚
â”‚  â”‚ â”‚ Polyline    â”‚    â”‚ â”‚ Extract Coords  â”‚  â”‚  â”‚ + Alerts        â”‚              â”‚ â”‚
â”‚  â”‚ â”‚ + Traffic   â”‚    â”‚ â”‚                 â”‚  â”‚  â”‚                 â”‚              â”‚ â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚ â”‚
â”‚  â”‚       â”‚            â”‚          â”‚           â”‚                                    â”‚ â”‚
â”‚  â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼           â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ Route-Aware     â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ Classification: â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â€¢ OnRoute       â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â€¢ Nearby        â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â€¢ Distant       â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚          â”‚           â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚          â–¼           â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ Alert           â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ Enhancement     â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚                 â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ ContentHasher   â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚       â”‚         â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚       â–¼         â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”‚ Check Cache â”‚ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”‚ 24h TTL     â”‚ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚       â”‚         â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚       â–¼         â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”‚ OpenAI API  â”‚ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â”‚ (if needed) â”‚ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚                                    â”‚ â”‚
â”‚  â”‚                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚                                               â”‚
â”‚                                     â–¼                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                              CACHE STORAGE                                     â”‚ â”‚
â”‚  â”‚                                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚  â”‚  roads:all      â”‚    â”‚ enhanced_alert:     â”‚    â”‚ Weather data    â”‚        â”‚ â”‚
â”‚  â”‚  â”‚  (5m TTL)       â”‚    â”‚ {content_hash}      â”‚    â”‚ (5m TTL)        â”‚        â”‚ â”‚
â”‚  â”‚  â”‚                 â”‚    â”‚ (24h TTL)           â”‚    â”‚                 â”‚        â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Road status   â”‚    â”‚                     â”‚    â”‚ â€¢ Current cond  â”‚        â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Traffic data  â”‚    â”‚ â€¢ AI enhanced       â”‚    â”‚ â€¢ Alerts        â”‚        â”‚ â”‚
â”‚  â”‚  â”‚ â€¢ Enhanced      â”‚    â”‚ â€¢ Structured desc   â”‚    â”‚                 â”‚        â”‚ â”‚
â”‚  â”‚  â”‚   alerts        â”‚    â”‚ â€¢ Impact/duration   â”‚    â”‚                 â”‚        â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Key Components and Data Flows

### 1. Request Processing Flow
- **Entry**: HTTP requests â†’ Prefab gRPC Gateway â†’ gRPC Service methods
- **Cache Strategy**: Check cache first, refresh if stale, return data
- **Background Warmth**: Periodic refresh simulates requests to maintain cache

### 2. External API Integration âœ… **SIMPLIFIED CONFIG**
- **Google Routes**: Traffic conditions + polylines (API key via `PF__GOOGLE_ROUTES__API_KEY`)
- **Caltrans KML**: Real-time incidents parsed from XML feeds  
- **OpenWeather**: Current conditions and weather alerts (API key via `PF__OPENWEATHER__API_KEY`)
- **OpenAI**: AI enhancement for alerts (API key via `PF__OPENAI__API_KEY`)

### 3. Data Processing Layers
- **Route-Aware Classification**: Uses actual Google polylines to classify alerts as OnRoute/Nearby/Distant
- **AI Enhancement**: Content-based caching prevents duplicate OpenAI calls
- **Geographic Processing**: Polyline decoding and coordinate-based filtering

### 4. Caching Architecture
- **Single Cache Instance**: JSON-based with TTL support
- **Multi-Layer TTL**: 5m for API data, 24h for enhanced alerts
- **Content-Based Deduplication**: Prevents redundant AI processing

### 5. Configuration System âœ… **NEWLY SIMPLIFIED**
- **Unified Structure**: Single config.Config struct with top-level client configurations
- **Environment Mapping**: Prefab transforms `PF__SECTION__FIELD_NAME` â†’ `section.fieldName`
- **Service Integration**: All services receive full config instead of sub-configs
- **Consistent Naming**: CamelCase throughout for predictable env var mapping

## Current Complexity Areas (Simplification Opportunities)

### ğŸ”„ Route-Aware Processing Pipeline
**Current Flow:**
```
Raw KML â†’ Parse â†’ Extract Coords â†’ Route Classification â†’ AI Enhancement â†’ Cache
```
**Complexity:** Multiple libraries (geo utils, route matcher, content hasher) handling overlapping concerns

### ğŸ§  AI Enhancement Chain  
**Current Flow:**
```
Content Hash â†’ Cache Check â†’ OpenAI API â†’ Parse Response â†’ Store Enhanced
```
**Complexity:** Separate caching logic from main cache, complex fallback handling

### ğŸŒ External API Client Patterns
**Similar Patterns:**
- Rate limiting and timeout handling
- JSON/XML parsing and error handling  
- Response caching and staleness detection

### ğŸ“Š Configuration Management âœ… **SIMPLIFIED**
**Unified Configuration Structure:**
- **Single Config Source**: Prefab YAML with environment variable mapping
- **Top-Level Client Configs**: GoogleRoutes, OpenAI, OpenWeather moved to root level  
- **CamelCase Consistency**: All fields use camelCase for Prefab env var transformation
- **Explicit Fields**: Replaced embedded RefreshConfig with explicit fields (koanf compatibility)
- **Environment Variables**: `PF__CLIENT__FIELD` â†’ `client.field` mapping works correctly

**Configuration Reduction:**
- **Before**: 125 lines, nested structures, inconsistent naming
- **After**: ~98 lines, flat structure, consistent camelCase naming
- **Eliminated**: Obsolete StoreConfig, unused chain_controls section

