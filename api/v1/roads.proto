syntax = "proto3";

package api.v1;

import "google/api/annotations.proto";
import "google/protobuf/timestamp.proto";
import "common.proto";

option go_package = "github.com/dpup/info.ersn.net/server/api/v1";

// RoadsService provides real-time road conditions and traffic information
service RoadsService {
  // ListRoads returns current conditions for all configured roads
  rpc ListRoads(ListRoadsRequest) returns (ListRoadsResponse) {
    option (google.api.http) = {
      get: "/api/v1/roads"
    };
  }

  // GetRoad returns current conditions for a specific road
  rpc GetRoad(GetRoadRequest) returns (GetRoadResponse) {
    option (google.api.http) = {
      get: "/api/v1/roads/{road_id}"
    };
  }

  // GetProcessingMetrics returns alert processing metrics
  rpc GetProcessingMetrics(GetProcessingMetricsRequest) returns (ProcessingMetrics) {
    option (google.api.http) = {
      get: "/api/v1/roads/metrics"
    };
  }
}

// Request messages
message ListRoadsRequest {}

message GetRoadRequest {
  string road_id = 1;
}

message GetProcessingMetricsRequest {}

// Response messages
message ListRoadsResponse {
  repeated Road roads = 1;
  google.protobuf.Timestamp last_updated = 2;
}

message GetRoadResponse {
  Road road = 1;
  google.protobuf.Timestamp last_updated = 2;
}

message ProcessingMetrics {
  int64 total_raw_alerts = 1;
  int64 filtered_alerts = 2;
  int64 enhanced_alerts = 3;
  int64 enhancement_failures = 4;
  double avg_processing_time_ms = 5;
}

// Data models
message Road {
  string id = 1;
  string name = 2;                    // Highway/road name (e.g., "Hwy 4")
  string section = 3;                 // Section description (e.g., "Arnold to Bear Valley")
  RoadStatus status = 4;              // Current road status
  int32 duration_minutes = 5;         // Current travel time in minutes
  int32 distance_km = 6;              // Route distance in kilometers
  CongestionLevel congestion_level = 7; // Traffic congestion level
  int32 delay_minutes = 8;            // Additional time due to traffic (0 = no delays)
  ChainControlStatus chain_control = 9; // Chain control requirements
  repeated RoadAlert alerts = 10;     // Combined from multiple sources
  // Note: origin, destination, route_polyline, and max_alert_distance are kept internal for processing
}


// TrafficCondition merged into Road for simplicity

message RoadAlert {
  AlertType type = 1;
  AlertSeverity severity = 2;
  AlertClassification classification = 3;  // On route vs nearby vs distant
  string title = 4;                        // Actual Caltrans title (e.g., "CHP Incident 250911GG0206")
  string description = 5;                  // AI-processed description
  string condensed_summary = 6;            // Short format for mobile
  google.protobuf.Timestamp start_time = 7;
  google.protobuf.Timestamp end_time = 8;
  google.protobuf.Timestamp last_updated = 9;
  Coordinates location = 10;               // Structured location with lat/lon
  string location_description = 11;        // Human-friendly location description
  string impact = 12;                      // AI-assessed impact: "none", "light", "moderate", "severe"
  string duration = 13;                    // AI-assessed duration: "unknown", "< 1 hour", "several hours", "ongoing"
  google.protobuf.Timestamp time_reported = 14;  // When incident was first reported
  map<string, string> metadata = 15;      // Additional AI-generated key-value pairs only
  // Note: id, original_description removed for cleaner API
  // Note: affected_segments, affected_polyline, structured_data, enhancement_info, 
  // distance_to_route, and affected_route_ids are kept internal for processing
}

// Note: StructuredDescription and EnhancementMetadata removed - AI-enhanced data 
// now goes into the generic metadata map for simpler API structure

message TrafficIncident {
  string id = 1;
  string description = 2;
  float location_mile_marker = 3;
  int32 estimated_delay_minutes = 4;
}

// Enumerations
enum RoadStatus {
  ROAD_STATUS_UNSPECIFIED = 0;
  OPEN = 1;
  CLOSED = 2;
  RESTRICTED = 3;
  MAINTENANCE = 4;
}

enum ChainControlStatus {
  CHAIN_CONTROL_UNSPECIFIED = 0;
  NONE = 1;
  ADVISED = 2;
  REQUIRED = 3;
  PROHIBITED = 4;
}

enum CongestionLevel {
  CONGESTION_LEVEL_UNSPECIFIED = 0;
  CLEAR = 1;
  LIGHT = 2;
  MODERATE = 3;
  HEAVY = 4;
  SEVERE = 5;
}

enum AlertType {
  ALERT_TYPE_UNSPECIFIED = 0;
  CLOSURE = 1;
  CONSTRUCTION = 2;
  INCIDENT = 3;
  WEATHER = 4;
}

enum AlertSeverity {
  ALERT_SEVERITY_UNSPECIFIED = 0;
  INFO = 1;
  WARNING = 2;
  CRITICAL = 3;
}

enum AlertClassification {
  ALERT_CLASSIFICATION_UNSPECIFIED = 0;
  ON_ROUTE = 1;      // Directly affects route path (< 100m from route)
  NEARBY = 2;        // In surrounding area but not blocking route (< route threshold)
  DISTANT = 3;       // Too far from route to be relevant (> route threshold)
}
